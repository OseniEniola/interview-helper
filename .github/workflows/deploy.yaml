name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        HOST: ${{ secrets.EC2_HOST }}
        USER: ${{ secrets.EC2_USER }}
      run: |
        echo "$PRIVATE_KEY" > private_key
        chmod 600 private_key
        
        ssh -o StrictHostKeyChecking=no -i private_key ${USER}@${HOST} << 'ENDSSH'
          set -e
          
          # Navigate to app directory
          cd /home/ec2-user/interview-helper
          
          # Pull latest changes
          echo "Pulling latest code..."
          git pull origin main
          
          # Stop containers
          echo "Stopping containers..."
          docker-compose down
          
          # Rebuild and start containers
          echo "Building and starting containers..."
          docker-compose up -d --build
          
          # Clean up old images
          echo "Cleaning up old images..."
          docker image prune -af
          
          # Show status
          echo "Deployment complete! Container status:"
          docker-compose ps
          
          # Show recent logs
          echo "Recent logs:"
          docker-compose logs --tail=20
        ENDSSH
        
        rm -f private_key
    
    - name: Deployment Status
      run: echo "âœ… Deployment completed successfully!"